# N8M-Jarvis — n8n + PostgreSQL + Caddy (Let’s Encrypt)

Интерактивный установщик разворачивает **n8n**, **PostgreSQL** и **Caddy** с автоматическими сертификатами HTTPS от Let’s Encrypt.  
Первый запрос — выбор **языка (EN/RU)**, по умолчанию **английский**. Вебхуки Telegram работают «из коробки» на **443 порту** за счёт реверс‑прокси.

> Репозиторий: https://github.com/evdokimenkoiv/N8M-Jarvis

## Быстрый старт (Ubuntu)
```bash
curl -fsSL https://raw.githubusercontent.com/evdokimenkoiv/N8M-Jarvis/main/install_n8n.sh -o install_n8n.sh
chmod +x install_n8n.sh && ./install_n8n.sh
```

После установки откройте `https://<домен>/` и создайте учётную запись администратора n8n.

---

## Что делает установщик (по шагам)

1. **Выбор языка (EN/RU)**  
   Определяет язык сообщений для текущего запуска.

2. **Сбор параметров**  
   - **Домен (FQDN)** — например, `automation.example.com`  
   - **E‑mail для Let’s Encrypt** — для уведомлений (по умолчанию `admin@<домен>`)  
   - **Часовой пояс** — применяется в n8n (по умолчанию `Europe/Amsterdam`)  
   - **Каталог установки** — где будут файлы и данные (по умолчанию `/opt/n8n`)  
   - **Тэг образа PostgreSQL** — например, `15-alpine` (по умолчанию)  
   - **Настройка UFW** — открыть **22/80/443** и включить файрвол (опционально)  
   - **LE STAGING CA** — использование тестового ACME-эндпоинта (опционально)

3. **Проверка DNS (best‑effort)**  
   Сверяет резолв домена с публичным IP сервера и предупреждает, если они отличаются (сертификат может не выдаться до обновления DNS).

4. **Устанавливает Docker Engine + compose v2** (если не стоят)  
   Подключает репозиторий Docker и ставит `docker-ce`, `docker-compose-plugin` и т.п.

5. **Готовит каталог установки**  
   Создаёт выбранный каталог (по умолчанию `/opt/n8n`) и переходит в него.

6. **Генерирует секреты и пишет `.env`**  
   - `POSTGRES_PASSWORD` — случайный надёжный пароль  
   - `N8N_ENCRYPTION_KEY` — ключ шифрования учётных данных n8n  
   - Базовые переменные (домен, e‑mail, часовой пояс, тег Postgres)  
   - n8n‑URL’ы: `N8N_EDITOR_BASE_URL`, `WEBHOOK_URL` выставлены в **`https://<домен>/`**

7. **Создаёт `Caddyfile`**  
   - Задаёт e‑mail для ACME и опционально **staging** CA  
   - Прокси `https://<домен>/` → `n8n:5678`  
   - Caddy автоматически получает и **продлевает** сертификаты (certbot не нужен).

8. **Создаёт `docker-compose.yml`** из трёх сервисов:  
   - `postgres` — база данных для n8n  
   - `n8n` — движок автоматизации (использует БД и переменные из `.env`)  
   - `caddy` — реверс‑прокси, TLS на **80/443** (авто‑HTTPS)  
   Данные сохраняются в подкаталогах/томах каталога установки.

9. **(Опционально) Настраивает UFW**  
   Открывает **OpenSSH/HTTP/HTTPS** и включает `ufw`, если установлен.

10. **Запускает стек**  
    Делает `docker compose up -d`, ждёт до ~60 сек, пока `https://<домен>` начнёт отвечать, далее печатает полезные подсказки.

---

## Требования и предпосылки

- Ubuntu с доступом `sudo` (современные LTS).  
- Внешние **порты 80 и 443** доступны из Интернета.  
- DNS **A/AAAA** домена указывает на публичный IP сервера.  
- Разрешён исходящий HTTPS (Caddy общается с Let’s Encrypt).

---

## Файлы и данные (в каталоге установки)

- `docker-compose.yml` — описание сервисов  
- `Caddyfile` — настройки реверс‑прокси и ACME  
- `.env` — сгенерированные секреты и переменные окружения  
- `n8n_data/` — данные n8n (учётные данные, настройки и т.д.)  
- `postgres/` — данные PostgreSQL  
- `caddy_data/`, `caddy_config/` — тома Caddy (сертификаты и конфигурация)

> **Берегите `.env` и `n8n_data/`** — содержат ключи и состояние приложения.

---

## Сеть и вебхуки

- Снаружи доступ по **HTTPS 443** (и HTTP 80 для ACME).  
- `WEBHOOK_URL=https://<домен>/` гарантирует корректные публичные URL вебхуков (порт 5678 не «торчит» наружу).  
- **Telegram** принимает вебхуки на 443/80/88/8443 — мы используем **443**, доп. настройки не нужны.

---

## Эксплуатация

### Обновление n8n / образов
```bash
cd /opt/n8n               # или ваш путь
sudo docker compose pull
sudo docker compose up -d
```

### Резервное копирование
- Сохраняйте: `n8n_data/`, `postgres/`, `caddy_data/`, `caddy_config/`, а также `.env`.

### Восстановление
- Верните эти каталоги в каталог установки и выполните:
```bash
sudo docker compose up -d
```

### Удаление
```bash
curl -fsSL https://raw.githubusercontent.com/evdokimenkoiv/N8M-Jarvis/main/uninstall.sh -o uninstall.sh
chmod +x uninstall.sh && ./uninstall.sh
```
Скрипт остановит стек и по выбору удалит тома (данные!), каталог установки и даже Docker Engine.

---

## Смена домена после установки

1. Остановите стек: `sudo docker compose down`  
2. Обновите `DOMAIN` (и связанные URL) в `.env` и `Caddyfile`  
3. Запустите снова: `sudo docker compose up -d`

> Caddy заново выпустит сертификаты для нового домена (убедитесь, что DNS обновлён и порты 80/443 открыты).

---

## Частые проблемы

- **Сертификат не выдался / только HTTP**  
  - Проверьте, что DNS домена указывает на публичный IP сервера и записи **пропагировались**.  
  - Убедитесь, что порты **80/443** открыты в облачном/провайдерском файрволе и `ufw`.  
  - Посмотрите логи: `sudo docker logs caddy | grep -Ei 'acme|certificate|obtaining|renew'`

- **Сначала staging, потом production**  
  - Запустите установщик заново без staging **или** удалите строку `acme_ca` из `Caddyfile` и выполните:  
    ```bash
    sudo docker compose up -d
    ```

- **Конфликты портов**  
  - Если 80/443 заняты другим сервисом — остановите/отключите его или поменяйте порты. Caddy должен слушать 80/443 для выпуска и обслуживания сертификатов.

---

## Скрипт удаления

`uninstall.sh` останавливает и удаляет контейнеры, а также по выбору удаляет:  
- Docker‑**тома** (потеря данных!),  
- **каталог установки** (файлы/конфиги),  
- пакеты **Docker Engine**, установленные через APT.

---
